name: graalvm-native-matrix

on:
    push:
        branches: [ "main" ]
    pull_request:

jobs:
    native:
        strategy:
            fail-fast: false
            matrix:
                include:
                    # macOS ARM
                    -   os: macos-15
                        arch: arm64
                        artifact: macos-arm64

                    # macOS Intel
                    -   os: macOS-15
                        arch: x86_64
                        artifact: macos-x86_64

                    # Linux ARM
                    -   os: ubuntu-24.04-arm
                        arch: arm64
                        artifact: linux-arm64

                    # Linux x86
                    -   os: ubuntu-latest
                        arch: x86_64
                        artifact: linux-x86_64

        runs-on: ${{ matrix.os }}

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup GraalVM JDK 21
                uses: graalvm/setup-graalvm@v1
                with:
                    distribution: 'graalvm'
                    java-version: '21'
                    github-token: ${{ secrets.GITHUB_TOKEN }}
                    cache: gradle

            -   name: Verify environment
                run: |
                    uname -a
                    java -version
                    native-image --version

            -   name: Grant gradlew permission
                run: chmod +x gradlew

            -   name: Native compile
                run: |
                    ./gradlew nativeCompile \
                      --no-daemon

            -   name: Rename binary
                run: |
                    # Find the executable file in the native compile output directory
                    EXECUTABLE_PATH=$(find build/native/nativeCompile -type f -executable | head -n 1)
                    if [ -z "$EXECUTABLE_PATH" ]; then
                      echo "Error: No executable found in build/native/nativeCompile"
                      ls -la build/native/nativeCompile
                      exit 1
                    fi
                    EXECUTABLE_NAME=$(basename "$EXECUTABLE_PATH")
                    NEW_NAME="${EXECUTABLE_NAME}-${{ matrix.artifact }}"
                    echo "Renaming $EXECUTABLE_NAME to $NEW_NAME"
                    mv "$EXECUTABLE_PATH" "build/native/nativeCompile/$NEW_NAME"
                    echo "Successfully renamed executable"

            -   name: Upload artifact
                uses: actions/upload-artifact@v4
                with:
                    name: ${{ matrix.artifact }}
                    path: build/native/nativeCompile/*
